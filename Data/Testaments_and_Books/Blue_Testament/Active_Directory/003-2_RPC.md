<!---------------------------------------------------------------------------------
Copyright: (c) BLS OPS LLC.
This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, version 3.
This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.
You should have received a copy of the GNU General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.
--------------------------------------------------------------------------------->
#RPC
### References


### Tools

* [Zero Network's GitHub: RPC Firewall](Testaments_and_Books/Blue_Testament/Tools/RPCFirewall.md)

### Protocols

* <details><summary>MS-SCMR: Service Control Manager Remote Protocol ([`Create or Modify System Process - Windows Service` TTP](TTP/T1543_Create_or_Modify_System_Process/003_Windows_Service/T1543.003.md)) (Click to expand)</summary><p>
	* <details><summary>References (Click to expand)</summary><p>
		* [https://github.com/jsecurity101/MSRPC-to-ATTACK/blob/main/documents/MS-SCMR.md](https://github.com/jsecurity101/MSRPC-to-ATTACK/blob/main/documents/MS-SCMR.md)
		* [https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-scmr/d5bd5712-fa64-44bf-9433-3651f6a5ce97](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-scmr/d5bd5712-fa64-44bf-9433-3651f6a5ce97)
		* [https://posts.specterops.io/utilizing-rpc-telemetry-7af9ea08a1d5](https://posts.specterops.io/utilizing-rpc-telemetry-7af9ea08a1d5)
		* [https://attack.mitre.org/techniques/T1543/003/](https://attack.mitre.org/techniques/T1543/003/)
		* ATT&CK Relation
			* T1543.003 - Service Creation
	* Attacker Usage
		* Service control manager and server services, used to remotely start and stop services and execute commands
	* Interface UUID

			367ABB81-9844-35F1-AD32-98F038001003
	* Server Binary

			services.exe
	* Endpoint

			ncacn_ip_tcp
			ncacn_np: \PIPE\ntsvcs alias \PIPE\svcctl
	* <details><summary>Indicator of Activity (IOA) (Click to expand)</summary><p>
	   * Network
			* Network connection to services.exe over TCP_IP Port
				* Window Security Event 5156
				* Sysmon Event 3
			* Methods seen over network
				* ROpenSCManager(A/W)/ROpenSCManager2
				* RCreateService(A/W)/RCreateServiceWOW64(A/W)/RCreateWowService
	 *	Host
			* Registry Key created / modified within HKLM\SYSTEM\CurrentControlSet\Services subkey
				* Sysmon Event 12/13
			* Window Securty Event 4624
				* Logon Type 3
				* Account Name isn't a machine account ($)
				* Source IP / Source Port = Network Source Port/IP
			* Window Security Event 4697
			* Windows System Event 7045
	* <details><summary>Prevention (Click to expand)</summary><p>
		* Modify permissions for the Services subkey on who can/cannot interact with it.
		* RPC Filter Example

				rpc
				filter
				add rule layer=um actiontype=permit
				add condition field=if_uuid matchtype=equal data=367ABB81-9844-35F1-AD32-98F038001003
				add condition field=remote_user_token matchtype=equal data=D:(A;;KA;;;DA)
				add filter
				add rule layer=um actiontype=block
				add condition field=if_uuid matchtype=equal data=367ABB81-9844-35F1-AD32-98F038001003
				add filter
				quit
			* RPC Filter only allows Domain Administrators to create services remotely. DAs is probably not the group you want in this filter. By default local administrators and above can create services. The RPC filter only allows Domain Admins to have key access. Could create a "services" group and apply that group to the DACL instead. Change DACL to leverage the group SID - like : D:(A;;KA;;;S-1-5-21-3637186843-3378876361-2759896766-2106).
			* Have to make sure whatever group you put in the DACL is a local admin on the target host. Still need to pass the access checked based on the Service Control Manager's Security Descriptor.
* <details><summary>MS-DRSR: Directory Replication Service Remote Protocol ([`DCSync` TTP](TTP/T1003_OS_Credential_Dumping/006_DCSync/T1003.006.md), [`Rogue Domain Controller` TTP](TTP/T1207_Rogue_Domain_Controller/T1207.md)) (Click to expand)</summary><p>
	* <details><summary>References (Click to expand)</summary><p>
		* [https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-drsr/
		06205d97-30da-4fdc-a276-3fd831b272e0](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-drsr/06205d97-30da-4fdc-a276-3fd831b272e0)
		* https://adsecurity.org/?p=1729
		* https://attack.mitre.org/techniques/T1003/006/
		* https://medium.com/@jsecurity101/syncing-into-the-shadows-bbd656dd14c8
		* https://github.com/jsecurity101/MSRPC-to-ATTACK/blob/main/documents/MS-DRSR.md
	* ATT&CK Relation
		* [T1003.006 - DCSync](https://attack.mitre.org/techniques/T1003/006/)
		* [T1207 - Rogue Domain Controller](https://attack.mitre.org/techniques/T1207/)
	* Interface UUID
		* `e3514235-4b06-11d1-ab04-00c04fc2dcd2`
	* Server Binary
		* `ntdsai.dll` (loads into) `lsass.exe` on DCs.
	* Endpoint
		* ncacn_ip_tcp
	* <details><summary>Indicator of Activity (IOA) (Click to expand)</summary><p>
		* Network
		  * Methods
			* DCSync
			  * `IDL_DRSCrackNames`
			  * `IDL_DRSGetNCChanges`
			* DCShadow
			  * `IDL_DRSAddEntry`
			  * `IDL_DRSUpdateRefs`
			  * `IDL_DRSReplicaAdd`
	* Host
		* Inbound network connection to LSASS on domain controllers over TCP_IP Port.
		* Access to the Domain-DNS Class object `{19195a5b-6da0–11d0-afd3–00c04fd930c9}` with extended rights
			* `{1131f6aa-9c07-11d1-f79f-00c04fc2dcd2}`-DS-Replication-Get-Change
			* `{1131f6ad-9c07–11d1-f79f-00c04fc2dcd2}`- DS-Replication-Get-Changes-All
			
				* Window Security Event 4662
		* DCShadow specific
			* Seeing hosts be promoted to a global category server (GC)
	* <details><summary>Prevention (Click to expand)</summary><p>
		* Remove the replication based extended rights from DAs.
		* For force replication - create a new group and apply extended rights. Only use this group on a case by case basis.
		* Remove traffic ability between workstation <-> domain controllers (DC <-> DC is normal traffic) (firewall or rpc filter)
		* RPC Firewall Example (edit the DC addresses to match your environment)

				fw:uuid:e3514235-4b06-11d1-ab04-00c04fc2dcd2 addr:<dc_addr1> action:allow audit:true 
				fw:uuid:e3514235-4b06-11d1-ab04-00c04fc2dcd2 addr:<dc_addr2> action:allow audit:true 
				fw:uuid:e3514235-4b06-11d1-ab04-00c04fc2dcd2 opnum:0 action:allow audit:true 
				fw:uuid:e3514235-4b06-11d1-ab04-00c04fc2dcd2 opnum:1 action:allow audit:true 
				fw:uuid:e3514235-4b06-11d1-ab04-00c04fc2dcd2 opnum:12 action:allow audit:true 
				fw:uuid:e3514235-4b06-11d1-ab04-00c04fc2dcd2 action:block audit:true 
		* RPC Filter Example

				rpc
				filter
				add rule layer=um actiontype=permit
				add condition field=if_uuid matchtype=equal data=e3514235-4b06-11d1-ab04-00c04fc2dcd2
				add condition field=remote_user_token matchtype=equal data=D:(A;;CC;;;DD)
				add filter
				add rule layer=um actiontype=block
				add condition field=if_uuid matchtype=equal data=e3514235-4b06-11d1-ab04-00c04fc2dcd2
				add filter
				quit
			* Filter forces the interface `e3514235-4b06-11d1-ab04-00c04fc2dcd2` to only accept calls coming from other DCs (the DD in the SDDL string).
			* RPC filter hasn't been tested in production. Things to keep in mind if pushed out
			 	* gpupdate.exe will fail on workstations. Use `Invoke-GPUpdate` on DC's.
			 	* Functionality issues may arise as a good amount of services/actions leverage replication within their process. Name conversions allow clients to map the different names used to identify directory service objects through `DsCrackNames` under the hood which is apart of this RPC interface.
					* Example - Splunk Universal Forwarder can use `DsCrackNames` to help with name resolution.
			 	* Force replication by a user on a domain controller will fail.
			 	* Normal replication will occur as needed by the DC.
			 	* [Andrew Robbins](https://twitter.com/_wald0) suggests restricting domain admins interactive logons on DCs. Aka - don't allow DA's to login to hosts within the organization, but create groups for specific use cases.
* <details><summary>MS-RRP: Windows Remote Registry Remote Protocol ([`Query Registry` TTP](TTP/T1012_Query_Registry/T1012.md), [`Modify Registry` TTP](TTP/T1112_Modify_Registry/T1112.md)) (Click to expand)</summary><p>
	* <details><summary>References (Click to expand)</summary><p>
		* [https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rrp/0fa3191d-bb79-490a-81bd-54c2601b7a78](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rrp/0fa3191d-bb79-490a-81bd-54c2601b7a78)
		* https://github.com/jsecurity101/MSRPC-to-ATTACK/blob/main/documents/MS-RRP.md
		* ATT&CK Relation
			* <details><summary>References (Click to expand)</summary><p>
				* [T1112 - Modify Registry](https://attack.mitre.org/techniques/T1112/)
				* [T1012 - Query Registry](https://attack.mitre.org/techniques/T1012/)
				* https://car.mitre.org/analytics/CAR-2014-11-005/
	* <details><summary>Overview (Click to expand)</summary><p>
		* By default local administrators can start the remote registry service and interact with the registry remotely.
		* If remote registry is an operational need, create a group specific to this action. Apply changes to the registry/rpc filter.
	* Attacker Usage
		* Remote registry service, used to access the system registry
	* Protocol
		* [Remote Registry (MS-RRP)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rrp/0fa3191d-bb79-490a-81bd-54c2601b7a78)
	* Interface UUID
		* `338CD001-2244-31F1-AAAA-900038001003`
	* Server Binary
		* `regsvc.dll` (loads into) `svchost.exe`
	* Endpoint
		* ncacn_np: `\PIPE\winreg`
	* <details><summary>Indicator of Activity (IOA) (Click to expand)</summary><p>
		* Network
		  * Methods
			* `BaseRegCreateKey`
			* `BaseRegQueryInfoKey`
			* `BaseRegSetValue`
		* Host
		  * Inbound network connection to: System over `\pipe\winreg`
		  * Registry key modifications
			* Sysmon Event ID 12/13
		  * Native windows binary to interact with registry remotely: reg.exe (look for ADD/QUERY parameters)
			* Process creation events
		  * Remote Registry Service start type changed
	* <details><summary>Prevention (Click to expand)</summary><p>
	* Turn off the remote registry service and disable it.
	* Modify permissions on sensitive registry keys
	* RPC Filter Example

			rpc
			filter
			add rule layer=um actiontype=permit
			add condition field=if_uuid matchtype=equal data=338CD001-2244-31F1-AAAA-900038001003
			add condition field=remote_user_token matchtype=equal data=D:(A;;KA;;;DA)
			add filter
			add rule layer=um actiontype=block
			add condition field=if_uuid matchtype=equal data=367ABB81-9844-35F1-AD32-98F038001003
			add filter
			quit
* <details><summary>MS-TSCH: Task Scheduler Service Remoting Protocol ([`Scheduled Task/Job` TTP](TTP/T1053_Scheduled_Task-Job/T1053.md)) (Click to expand)</summary><p>
	* <details><summary>References (Click to expand)</summary><p>
		* [https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rrp/0fa3191d-bb79-490a-81bd-54c2601b7a78](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-tsch/d1058a28-7e02-4948-8b8d-4a347fa64931)
		* https://posts.specterops.io/abstracting-scheduled-tasks-3b6451f6a1c5
		* https://github.com/jsecurity101/MSRPC-to-ATTACK/blob/main/documents/MS-TSCH.md
		* ATT&CK Relation
			* [T1053 - Scheduled Task](https://attack.mitre.org/techniques/T1053/)
			* SASec is used to get or set account information that is associated with tasks.
	* <details><summary>Overview (Click to expand)</summary><p>
		* By default local administrators can create/start scheduled tasks remotely.
		* If remote scheduled tasks is an operational need, create a group specific to this action. Apply changes to the rpc filter, remove DAs from the SDDL string.
	* Attacker Usage
		* `1ff70682-0a51-30e8-076d-740be8cee98b`- Task scheduler, used to remotely execute commands
	* Protocol
		* [Scheduled Task (MS-TSCH)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-tsch/d1058a28-7e02-4948-8b8d-4a347fa64931)
	* Interface UUID
		* `1FF70682-0A51-30E8-076D-740BE8CEE98B` (GUID_ATSvc)
		* `378E52B0-C0A9-11CF-822D-00AA0051E40F` (GUID_SASec)
		* `86D35949-83C9-4044-B424-DB363231FD0C` (GUID_ITaskSchedulerService)
	* Server Binary
		* ATSvc/SASec
			* `taskcomp.dll` (loads into) `svchost.exe`
		* ITaskSchedulerService
			* `schedsvc.dll` (loads into) `svchost.exe`
	* Endpoint
		* ATSvc/SASec
			* ncacn_np: `\pipe\atsvc`
	* ITaskSchedulerService
		* ncacn_ip_tcp
		* ncacn_np: `\pipe\atsvc`
	* <details><summary>Indicator of Activity (IOA) (Click to expand)</summary><p>
		* Network
		  * Methods
			* ITaskSchedulerServices
				* `SchRpcRegisterTask`
				* `SchRpcEnumTasks`
			* ATSVC
				* `NetrJobAdd`
		* Host
		  * Inbound network connection to `svchost.exe` over pipe `\pipe\atsvc` or `TCP_IP port`
	  * Registry Key Creation
		  * `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree`
		  * `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tasks`
	  * Sysmom Event 12/13
	  * File Creation
		* `C:\Windows\System32\Tasks` OR `C:\Windows\Tasks` OR `C:\Windows\SYSWOW64\Tasks`
		* Sysmon Event 11
	* <details><summary>Prevention (Click to expand)</summary><p>
	* RPC Filter Example

			rpc
			filter
			add rule layer=um actiontype=permit
			add condition field=if_uuid matchtype=equal data=1FF70682-0A51-30E8-076D-740BE8CEE98B
			add condition field=remote_user_token matchtype=equal data=D:(A;;CC;;;DA)
			add filter
			add rule layer=um actiontype=block
			add condition field=if_uuid matchtype=equal data=1FF70682-0A51-30E8-076D-740BE8CEE98B
			add filter
			add rule layer=um actiontype=permit
			add condition field=if_uuid matchtype=equal data=378E52B0-C0A9-11CF-822D-00AA0051E40F
			add condition field=remote_user_token matchtype=equal data=D:(A;;CC;;;DA)
			add filter
			add rule layer=um actiontype=block
			add condition field=if_uuid matchtype=equal data=378E52B0-C0A9-11CF-822D-00AA0051E40F
			add filter
			add rule layer=um actiontype=permit
			add condition field=if_uuid matchtype=equal data=86D35949-83C9-4044-B424-DB363231FD0C
			add condition field=remote_user_token matchtype=equal data=D:(A;;CC;;;DA)
			add filter
			add rule layer=um actiontype=block
			add condition field=if_uuid matchtype=equal data=86D35949-83C9-4044-B424-DB363231FD0C
			add filter
			quit
* <details><summary>MS-WKST: Workstation Service Remote Protocol( [`Create or Modify System Process - Windows Service` TTP](TTP/T1543_Create_or_Modify_System_Process/003_Windows_Service/T1543.003.md)) (Click to expand)</summary><p>
	* <details><summary>References (Click to expand)</summary><p>
		* [https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-tsch/d1058a28-7e02-4948-8b8d-4a347fa64931](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wkst/5bb08058-bc36-4d3c-abeb-b132228281b7)
		* https://posts.specterops.io/utilizing-rpc-telemetry-7af9ea08a1d5
		* [https://attack.mitre.org/techniques/T1543/003/](https://attack.mitre.org/techniques/T1543/003/)
		* https://github.com/jsecurity101/MSRPC-to-ATTACK/blob/main/documents/MS-WKST.md
	* <details><summary>Overview (Click to expand)</summary><p>
		* By default local administrators and above can create services. The RPC filter only allows Domain Admins to have key access. Could create a "services" group and apply that group to the DACL instead. Change DACL to leverage the group SID - like : D:(A;;KA;;;S-1-5-21-3637186843-3378876361-2759896766-2106).
		* Have to make sure whatever group you put in the DACL is a local admin on the target host. Still need to pass the access checked based on the Service Control Manager's Security Descriptor.
	* Attacker Usage
		* `367abb81-9844-35f1-ad32-98f038001003` - Service control manager and server services, used to remotely start and stop services and execute commands
	* ATT&CK Relation
		* [T1543.003 - Service Creation](https://attack.mitre.org/techniques/T1543/003/)
	* Protocol
		* [Service Control Manager Remote Protocol (MS-SCMR)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-scmr/705b624a-13de-43cc-b8a2-99573da3635f)
	* Interface UUID
		* `367ABB81-9844-35F1-AD32-98F038001003`
	* Server Binary
		* services.exe
	* Endpoint
		* ncacn_ip_tcp
		* ncacn_np: `\PIPE\ntsvcs` alias `\PIPE\svcctl`
	* <details><summary>Indicator of Activity (IOA) (Click to expand)</summary><p>
		* Network
			* Network connection to services.exe over TCP_IP Port
				* Window Security Event 5156
				* Sysmon Event 3
			* Methods seen over network
				* `ROpenSCManager(A/W)/ROpenSCManager2`
				* `RCreateService(A/W)/RCreateServiceWOW64(A/W)/RCreateWowService`
		* Host
			* Registry Key created / modified within HKLM\SYSTEM\CurrentControlSet\Services subkey
				* Sysmon Event 12/13
			* Window Securty Event 4624
				* Logon Type 3
				* Account Name isn't a machine account ($)
				* Source IP / Source Port = Network Source Port/IP
		  * Window Security Event 4697
		  * Windows System Event 7045
	* <details><summary>Prevention (Click to expand)</summary><p>
		* Modify permissions for the Services subkey on who can/cannot interact with it.
	* RPC Filter Example

			rpc
			filter
			add rule layer=um actiontype=permit
			add condition field=if_uuid matchtype=equal data=367ABB81-9844-35F1-AD32-98F038001003
			add condition field=remote_user_token matchtype=equal data=D:(A;;KA;;;DA)
			add filter
			add rule layer=um actiontype=block
			add condition field=if_uuid matchtype=equal data=367ABB81-9844-35F1-AD32-98F038001003
			add filter
			quit
		* RPC Filter only allows Domain Administrators to create services remotely. DAs is probably not the group you want in this filter. See Notes.
* <details><summary>MS-SRVS: Server Service Remote Protocol ([`Remote System Discovery` TTP](TTP/T1018_Remote_System_Discovery/T1018.md)) (Click to expand)</summary><p>
	* <details><summary>References (Click to expand)</summary><p>
		* [https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wkst/5bb08058-bc36-4d3c-abeb-b132228281b7](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-srvs/accf23b0-0f57-441c-9185-43041f1b0ee9)
		* https://www.darktrace.com/en/blog/making-the-red-team-wave-the-white-flag-with-darktrace-ai/ https://www.sentinelone.com/blog/deep-dive-exploring-an-ntlm-brute-force-attack-with-bloodhound/ https://en.hackndo.com/ntlm-relay/
		* https://github.com/p0w3rsh3ll/NetCease
		* https://github.com/jsecurity101/MSRPC-to-ATTACK/blob/main/documents/MS-SRVS.md
	* <details><summary>Overview (Click to expand)</summary><p>
		* Adding `NT AUTHORITY\BATCH, NT AUTHORITY\INTERACTIVE, NT AUTHORITY\SERVICE` to filter might help with compatibility/functionality issues.
		* Lanman Server
			* System Enumeration
				* User Session Enumuration (`NetSessionEnum/NetrSessionEnum`)
				* Share Enumeration (`NetShareEnum/NetrShareEnum`)
				* Connection Enumeration (`NetConnectionEnum/NetrConnectionEnum`)
				* File Enumeration (`NetFileEnum/NetrFileEnum`)
		* Often seen with BH activity
		* Look for connection to named pipe (both client and server)
	* Attacker Usage
		* Service control manager and server services, used to remotely start and stop services and execute commands
	* ATT&CK Relation
		* [T1018 - Remote System Discovery](https://attack.mitre.org/techniques/T1018/)
		* System Enumeration
	* Protocol
		* [Server Service Remote Protocol (MS-SRVS)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-srvs/accf23b0-0f57-441c-9185-43041f1b0ee9)
	* Interface UUID
		* `4b324fc8-1670-01d3-1278-5a47bf6ee188`
	* Server Binary
		* `srvsvc.dll` (loads into) `svchost.exe`
	* Endpoint
		* ncacn_np: `\PIPE\srvsvc`
	* <details><summary>Indicator of Activity (IOA) (Click to expand)</summary><p>
		* Network
			* Inbound network connections to System over port 445
			 * Network connection to pipe - `\pipe\srvsvc`
			* Methods
				* `NetSessionEnum`
		* Host
			* Window Security Event 5145 (Detailed Network File Share)
				* Share Name: `IPC$ `
				* Relative Target Name: `\pipe\srvsvc`
				* Look at the user who made the connection
				* Access Request Information: Access Mask (0x3 or higher) (`ReadData or ListDirectory + WriteData or AddFile`)
				* **Note:**: BH has been seen to have the hardcoded rights: `0x12019f (READ_CONTROL, SYNCHRONIZE,  ReadData (or ListDirectory), WriteData (or AddFile), AppendData (or AddSubdirectory or CreatePipeInstance), ReadEA, WriteEA , ReadAttributes, WriteAttributes)`
	  	* Ransomware has been known to shut off the Lanman Server Service
	* <details><summary>Prevention (Click to expand)</summary><p>
		* Prevent relay attacks by enabling SMB signing
			* `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters\RequireSecuritySignature = 1`
			* `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters\EnableSecuritySignature = 1`
		* MSFT link for guidance: https://docs.microsoft.com/en-us/troubleshoot/windows-server/networking/overview-server-message-block-signing
		* [NetCease](https://github.com/p0w3rsh3ll/NetCease): Changes `HKEY_LOCAL_MACHINE/SYSTEM/CurrentControlSet/Services/LanmanServer/DefaultSecurity/SrvsvcInfo` binary value
	* RPC Filter Example

			rpc
			filter
			add rule layer=um actiontype=permit
			add condition field=if_uuid matchtype=equal data=4b324fc8-1670-01d3-1278-5a47bf6ee188
			add condition field=remote_user_token matchtype=equal data=D:(A;;CC;;;BA)
			add filter
			add rule layer=um actiontype=block
			add condition field=if_uuid matchtype=equal data=4b324fc8-1670-01d3-1278-5a47bf6ee188
			add filter
			quit
		* RPC filter to only allow Administrators
* <details><summary>MS-RPRN: Print System Remote Protocol, MS-PAR: Print System Asynchronous Remote Protocol ([Exploitation of Remote Services TTP](TTP/T1210_Exploitation_of_Remote_Services/T1210.md), [Boot or Logon Autostart Execution - Print Processors](TTP/T1547_Boot_or_Logon_Autostart_Execution/012_Print_Processors/T1547.012.md)) (Click to expand)</summary><p>
	* <details><summary>References (Click to expand)</summary><p>
		* https://github.com/jsecurity101/MSRPC-to-ATTACK/blob/main/documents/MS-RPRN-PAR.md
		* MS-RPRN
			* [https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/d42db7d5-f141-4466-8f47-0a4be14e2fc1](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/d42db7d5-f141-4466-8f47-0a4be14e2fc1)
		* MS-PAR
			* [https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-par/695e3f9a-f83f-479a-82d9-ba260497c2d0](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-par/695e3f9a-f83f-479a-82d9-ba260497c2d0)
		* https://www.slideshare.net/harmj0y/derbycon-the-unintended-risks-of-trusting-active-directory
		* https://www.sygnia.co/demystifying-the-printnightmare-vulnerability
		* https://github.com/leechristensen/SpoolSample
		* ATT&CK Relation
			* [Privilege Escalation](https://attack.mitre.org/tactics/TA0004/)
			* [Print Nightmare](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)
			* [Printer Bug](https://github.com/leechristensen/SpoolSample)
			* [T1210 - Exploitation of Remote Services](https://attack.mitre.org/techniques/T1210/)
			* [T1547.012 - Print Processors](https://attack.mitre.org/techniques/T1547/012/)
	* <details><summary>Overview (Click to expand)</summary><p>
		* Service Name: Spooler
		* Methods must specify object UUID: `9940CA8E-512F-4C58-88A9-61098D6896BD`
		* "The Printer Bug" was created by Lee Christensen and can be used to force authentication and extract the TGT of the target domain controller.
		* Print Nightmare (CVE-2021-1675) is a vulnerability that allows remote code execution to any workstation/server with the Spooler service enabled.
		* Adding RPC Filter, but honestly the best course of action is to disable spooler where possible. Could always overlap these prevention strategies. Aka - Turn off/Disable spooler, set RPC filter in the case someone turns it back on, and write detection logic for Spooler being turned on.
		* If RPC filter is applied, suggest creating a specific user and not DA to limit DA logins
	* Protocol
		* [Print System Remote Protocol (MS-RPRN)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/d42db7d5-f141-4466-8f47-0a4be14e2fc1)
		* [Print System Asynchronous Remote Protocol (MS-PAR)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-par/695e3f9a-f83f-479a-82d9-ba260497c2d0)
	* Interface UUID
		* 12345678-1234-ABCD-EF00-0123456789AB (MS-RPRN) (synchronous)
		* 76F03F96-CDFD-44FC-A22C-64950A001209 (MS-PAR- [IRemoteWinspool Interface](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-par/8405f9fc-556b-4bb4-b9bb-08b1e96802f3)) (asynchronous)
	* Server Binary
		* spoolsv.exe
	* Endpoint
		* ncacn_np: `\pipe\spoolss` (MS-RPRN)
		* ncacn_ip_tcp (dynamic endpoint) (MS-PAR)
	* <details><summary>Indicator of Activity (IOA) (Click to expand)</summary><p>
		* Print Nightmare
			* Network:
				* Methods
					* MS-PAR / `RpcAsyncAddPrinterDriver()`
					* MS-RPRN / `RpcAddPrinterDriverEx()`
			* Host
				* File created: `C:\Windows\System32\spool\drivers\(x64/W32X86)\*\*.dll`
				* Transfers/Loads a driver: `C:\Windows\System32\spool\drivers\(x64/W32X86)\*\*.dll`
				* Queries: `HKLM\Software\Policies\Microsoft\Windows NT\Printers` & `HKLM\System\CurrentControlSet\Control\Print\Environments\Windows x64\Drivers\Version-3\Microsoft enhanced Point and Print compatibility driver\*`
					* Set SACL on registry key within test environment and there didn't seem to be a lot of noise.
				* Registry Create: `HKLM\System\CurrentControlSet\Control\Print\Environments\Windows x64\Drivers\Version-*\*.dll` (x64 bit systems) / `HKLM\SYSTEM\CurrentControlSet\Control\Print\Environments\Windows NT x86\*.dll` (x86 bit systems)
				* 5156 - Inbound connection to spoolsv.exe over (pipe or tcp) from weird machines
				* `spoolsv.exe` spawns a process.
		* “The Printer Bug” vulnerability/Spool Service
			* Network
				* SMB activity over named pipe: `\pipe\spoolss`
				* Methods
				* `RpcRemoteFindFirstPrinterChangeNotification`
				* `RpcRemoteFindFirstPrinterChangeNotificationEx`
			* Host
				* Watch for 5145 events where domain controllers are being accessed via `IPC$` share through named pipe - `\pipe\spoolss`
				* Extra suspicious if activity is coming from domain controllers outside of current domain
		* Both
			* If Spooler is turned off/disabled - detection to trigger when it is enabled/turned back on.
	* <details><summary>Prevention (Click to expand)</summary><p>
		* Print Nightmare
			* Microsoft patch
				* Set all values to zero, if they exist in environment
					* `HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint`
					* `NoWarningNoElevationOnInstall = 0` (DWORD) or not defined (default setting)
					* `UpdatePromptSettings = 0` (DWORD) or not defined (default setting)
					* If `NoWarningNoElevationOnInstall = 1`, system is vulnerable
			* Turn off Spooler Service if possible, disable from starting back up on boot
			* Disable Spooler from accepting client connections (GPO setting)
			* Adjust `RestrictDriverInstallationToAdministrators` registry value to prevent non-administrators from installing printer drivers on a print server
			* RPC filters to make sure only a certain group has access to perform RPC method
			* Disable Point and Print in the registry: `reg add ""HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows NT\Printers\PointAndPrint"" /v Restricted /t REG_DWORD /d 0 /f`
		* Printer Bug
			* Turn off Spooler Service if possible, disable from starting back up on boot
			* Disable kerberos delegation where possible
			* Disable Spooler from accepting client connections (GPO setting)
			* Enable Account is sensitive and cannot be delegated for high privileged accounts
		* Both
			* RPC Filter Example

					rpc
					filter
					add rule layer=um actiontype=permit
					add condition field=if_uuid matchtype=equal data=12345678-1234-ABCD-EF00-0123456789AB
					add condition field=remote_user_token matchtype=equal data=D:(A;;CC;;;DA)
					add condition field=auth_level matchtype=equal data=6
					add filter
					add rule layer=um actiontype=block
					add condition field=if_uuid matchtype=equal data=12345678-1234-ABCD-EF00-0123456789AB
					add filter
					add rule layer=um actiontype=permit
					add condition field=if_uuid matchtype=equal data=76F03F96-CDFD-44FC-A22C-64950A001209
					add condition field=remote_user_token matchtype=equal data=D:(A;;CC;;;DA)
					add condition field=auth_level matchtype=equal data=6
					add filter
					add rule layer=um actiontype=block
					add condition field=if_uuid matchtype=equal data=76F03F96-CDFD-44FC-A22C-64950A001209
					add filter
					quit
			* Filter will only allow Domain Admins to communicate over interface `12345678-1234-ABCD-EF00-0123456789AB` & `76F03F96-CDFD-44FC-A22C-64950A001209`, where the authentication level is `RPC_C_AUTHN_LEVEL_PKT_PRIVACY (6)`. This is to prevent potential relay attacks from happening.
			* If you don't want to assign DA's to this DACL, so it might be best to create a Printer specific group or change it to Local Admins (BA).
* <details><summary>MS-SAMR: Security Account Manager Remote Protocol ([`Create Account - Domain Account` TTP](TTP/T1136_Create_Account/002_Domain_Account/T1136.002.md)), [`Permission Groups Discovery - Domain Groups` TTP](TTP/T1069_Permission_Groups_Discovery/002_Domain_Groups/T1069.002.md)) (Click to expand)</summary><p>
	* <details><summary>References (Click to expand)</summary><p>
		* [https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/4df07fab-1bbc-452f-8e92-7853a3c7e380](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/4df07fab-1bbc-452f-8e92-7853a3c7e380)
		* [https://stealthbits.com/blog/making-internal-reconnaissance-harder-using-netcease-and-samri1o/](https://stealthbits.com/blog/making-internal-reconnaissance-harder-using-netcease-and-samri1o/)
		* [https://github.com/shmitty275/powershell/blob/master/SAMRi10.ps1](https://github.com/shmitty275/powershell/blob/master/SAMRi10.ps1)
		* https://github.com/jsecurity101/MSRPC-to-ATTACK/blob/main/documents/MS-SAMR.md
	* <details><summary>Overview (Click to expand)</summary><p>
		* Often seen with BH activity. Look for connection to named pipe (both client and server)
		* Server, domain, group, alias and user can be read/read through SAMR.
		* User, group and alias can be created/deleted
		* MDI has alert set up that will trigger after first month: https://docs.microsoft.com/en-us/defender-for-identity/reconnaissance-alerts
		* If RPC Filter is applied, set up a "Remote SAM Group" and apply them to the filter
	* Attacker Usage
		* Used to access public SAM database elements (e.g., usernames) and brute-force user passwords regardless of account lockout policy 
	* Protocol
		* [Security Account Manager (SAM) Remote Protocol (MS-SAMR)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/4df07fab-1bbc-452f-8e92-7853a3c7e380)
	* Interface UUID
		* 12345778-1234-ABCD-EF00-0123456789AC
	* Server Binary
		* `samsrv.dll` (loads into) `lsass.exe`
	* Endpoint
		* ncacn_ip_tcp
		* ncacn_np: `\PIPE\lsass` alias `\pipe\samr`
	* ATT&CK Relation
		* [T1136.002 - Domain Account](https://attack.mitre.org/techniques/T1136/002/)
		* [T1069.002 - Domain Group](https://attack.mitre.org/techniques/T1069/002/)
	* <details><summary>Indicator of Activity (IOA) (Click to expand)</summary><p>
		* Network
		  * Network traffic over `\pipe\samr` or `\pipe\lsass`
		  * Destination port: 445
		  * Methods
			* `SamrOpenDomain`
			* `SamrOpenGroup`
			* `SamrLookupNames`
			* `SamrQueryGroupInfo`
			* `SamrEnumerateDomainsInSamServer`
			* `SamrEnumerateGroupsInDomain`
			* `SamrEnumerateAliasesInDomain`
			* `SamrEnumerateUsersInDomain`
		* Host
			* Event ID 5145
				* Share Name: `\\*\IPC$`
				* Relative Target Name: `samr`
				* Access Mask: `0x12019f` (Rights could be potentially less depending on the method called. Test was done via net.exe)
				* Object Type: `File`
				* Look at Source Address when investigating
	* <details><summary>Prevention (Click to expand)</summary><p>
		* Add RestrictRemoteSam in HKLM/System/CurrentControlSet/Control/Lsa to O:SYG:SYD:(A;;RC;;;BA) to only allow Local Admin (on DC)/Remote SAM User Group
		  * Tool that does this: https://github.com/shmitty275/powershell/blob/master/SAMRi10.ps1
	* RPC Filter Example

			rpc
			filter
			add rule layer=um actiontype=permit
			add condition field=if_uuid matchtype=equal data=12345778-1234-ABCD-EF00-0123456789AC
			add condition field=remote_user_token matchtype=equal data=D:(A;;RC;;;BA)
			add filter
			add rule layer=um actiontype=block
			add condition field=if_uuid matchtype=equal data=e3514235-4b06-11d1-ab04-00c04fc2dcd2
			add filter
			quit
		* RPC Filter to only allow local admins to use SAMR
* <details><summary>MS-LSAD: Local Security Authority (Domain Policy) Remote Protocol, MS-LSAT: Local Security Authority (Translation Methods) Remote Protocol ([`Account Discovery` TTP](TTP/T1087_Account_Discovery/T1087.md), [`Permission Groups Discovery - Domain Groups` TTP](TTP/T1069_Permission_Groups_Discovery/002_Domain_Groups/T1069.002.md)) (Click to expand)</summary><p>
	* <details><summary>References (Click to expand)</summary><p>
		* https://github.com/jsecurity101/MSRPC-to-ATTACK/blob/main/documents/MS-LSAD-LSAT.md
		* MS-LSAD [https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsad/1b5471ef-4c33-4a91-b079-dfcbb82f05cc](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsad/1b5471ef-4c33-4a91-b079-dfcbb82f05cc)
		* MS-LSAT [https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsat/1ba21e6f-d8a9-462c-9153-4375f2020894](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsat/1ba21e6f-d8a9-462c-9153-4375f2020894)
		* https://docs.microsoft.com/en-us/windows/win32/api/ntsecapi/nf-ntsecapi-lsaqueryinformationpolicy
	* <details><summary>Overview (Click to expand)</summary><p>
		* MS-LSAT is issued alongside MS-LSAD and leverages the same interface UUID.
		* Can be seen with enumeration activity.
		* By default domain users can query this information via: dsacls.exe "cn=users,dc=marvel,dc=local"
		* Created a RPC filter to only allow BA's (local admins) to perform this action, but note during testing it seemed that legitimate connections over these protocols were occurring. Unsure of the repercussions limiting the access to this protocol will cause. Could create a group that has BAs and Machine accounts, then apply that group SID to the filter.
	* Attacker Usage
		* LSA interface, used to enumerate users
	* Protocol
		* [Local Security Authority (Domain Policy) Remote Protocol (MS-LSAD)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsad/1b5471ef-4c33-4a91-b079-dfcbb82f05cc)
		* [Local Security Authority (Translation Methods) Remote Protocol (MS-LSAT)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsat/1ba21e6f-d8a9-462c-9153-4375f2020894)
	* Interface UUID
		* `12345778-1234-ABCD-EF00-0123456789AB`
	* Server Binary
		* `lsarpc.dll` (loads into) `lsass.exe`
	* Endpoint
		* ncacn_ip_tcp
		* ncacn_np: `\PIPE\lsass` alias `\pipe\lsarpc`
	* ATT&CK Relation
		* [T1087 - Account Discovery](https://attack.mitre.org/techniques/T1087/)
		* [T1069.002 - Domain Group](https://attack.mitre.org/techniques/T1069/002/)
	* <details><summary>Indicator of Activity (IOA) (Click to expand)</summary><p>
		* Network
			* Network traffic over: `\pipe\lsarpc` or `\pipe\lsass`
			* Destination port: `445`
		  * Methods
			* `LsarOpenPolicy*`
			* `LsarLookupSid*`
			* `LsarQueryInformationPolicy*`
			* `LsaSetInformatoinPolicy*`
			* `LsarEnumerateTrustedDomains`
			* `LsarEnumeratePrivileges`
			* `LsarEnumeratePrivilegesAccount`
			* `LsarEnumerateAccounts`
			* `LsarEnumerateAccountRights`
			* `LsarEnumerateAccountsWithUserRight`
			* `LsarQueryDomainInformationPolicy*`
		* Host
		  * Event ID 5145
			* Share Name: `\\*\IPC$`
			* Relative Target Name: `lsarpc`
			* Access Mask: `0x12019f` (Rights could be potentially less depending on the method called. Test was done via net.exe)
			* Object Type: `File`
			* Look at Source Address when investigating
			* User account will not be a machine account ($)
		* Potentially see a high volume of 5145's due to the number of enumeration requests
	* <details><summary>Prevention (Click to expand)</summary><p>
		* RPC Filter Example

				rpc
				filter
				add rule layer=um actiontype=permit
				add condition field=if_uuid matchtype=equal data=12345778-1234-ABCD-EF00-0123456789AB
				add condition field=remote_user_token matchtype=equal data=D:(A;;CC;;;BA)
				add filter
				add rule layer=um actiontype=block
				add condition field=if_uuid matchtype=equal data=12345778-1234-ABCD-EF00-0123456789AB
				add filter
				quit
		* Filter forces the interface `12345778-1234-ABCD-EF00-0123456789AB` to only accept calls coming from a local admin on the host (BA in the SDDL string).
* <details><summary>MS-EFSR: Encrypting File System Remote (EFSRPC) Protocol ([`Forced Authentication` TTP](TTP/T1187_Forced_Authentication/T1187.md), [` Adversary-in-the-Middle: LLMNR/NBT-NS Poisoning and SMB Relay ` TTP](TTP/T1557_Adversary-in-the-Middle/001_LLMNR-NBT-NS_Poisoning_and_SMB_Relay_By_responding_to_LLMNR-NBT-NS_network_traffic/T1557.001.md)) (Click to expand)</summary><p>
	* <details><summary>References (Click to expand)</summary><p>
		* [https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/08796ba8-01c8-4872-9221-1000ec2eff31](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/08796ba8-01c8-4872-9221-1000ec2eff31)
		* https://github.com/jsecurity101/MSRPC-to-ATTACK/blob/main/documents/MS-EFSR.md
		* Technique References
			* https://gist.github.com/tyranid/5527f5559041023714d67414271ca742
			* https://www.bleepingcomputer.com/news/microsoft/windows-security-update-blocks-petitpotam-ntlm-relay-attacks/
			* https://bugs.chromium.org/p/project-zero/issues/detail?id=2228
			* https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-43893
		* Mitigation References: https://support.microsoft.com/en-gb/topic/kb5005413-mitigating-ntlm-relay-attacks-on-active-directory-certificate-services-ad-cs-3612b773-4043-4aa9-b23d-b87910cd3429"
	* <details><summary>Overview (Click to expand)</summary><p>
		* Findings were made surrounding the domain joined compromise version of this attack, not the local privilege escalation implementation.
	* Protocol
		* [Encrypting File System Remote (EFSRPC) Protocol - (MS-EFSR)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/08796ba8-01c8-4872-9221-1000ec2eff31)
	* Interface UUID
		* `c681d488-d850-11d0-8c52-00c04fd90f7e` (unauthenticated implementation)
		* `df1941c5-fe89-4e79-bf10-463657acf44d`
	* Server Binary
		* `efslsaext.dll` (loads into) `lsass.exe`(unauthenticated implementation)
		* `efssvc.dll` (loads into) `lsass.exe`
	* Endpoint
		* ncacn_np: `\\pipe\lsass` alias `\\pipe\lsarpc` (unauthenticated implementation)
		* ncacn_np: `\\pipe\efsrpc`
	* ATT&CK Relation
		* [T1187 - Forced Authentication](https://attack.mitre.org/techniques/T1187/)
		* [T1557 - LLMNR/NBT-NS Poisoning and SMB Relay](https://attack.mitre.org/techniques/T1557/001/)
		* [PetitPotam](https://github.com/topotam/PetitPotamß)
	* <details><summary>Indicator of Activity (IOA) (Click to expand)</summary><p>
		* [PetitPotam](https://github.com/topotam/PetitPotam)
			* Network
			  * Inbound network connection over port 445
			  * Connection over pipe `lsarpc` or `lsass` (`lsarpc` is points to lsass)
			  * Connection over pipe `efsrpc`
			  * Methods
				* `EfsRpcOpenFileRaw` (patched by Microsoft via CVE-2021-36942)
				* `EfsRpcEncryptFileSrv`
				* `EfsRpcDecryptFileSrv`
				* `EfsRpcQueryUsersOnFile`
				* `EfsRpcQueryRecoveryAgents`
				* `EfsRpcRemoveUsersFromFile`
				* `EfsRpcAddUsersToFile`
			* Host
			  * (Server Side + Attack came from non-domain joined host)
				   * Event ID 5145 on Target
					 * `ANONYMOUS LOGON`
					 * Account Domain: `NT AUTHORITY`
					 * Object Type: `File`
					 * Share Name: `\\*\IPC$`
					 * Relative Target Name: `lsarpc`
					 * Access Mask:  `0x3`
					 * Accesses
						  * `ReadData (or ListDirectory)`
						   * `WriteData (or AddFile)`

					* Event ID 4624 on Target
					  * Logon Type: `3`
					  * Account Name: `Anonymous Logon`
					  * Account Domain: `NT SECURITY`
					  * Logon Process: `NtLmSsp`
			* For version where the source host is a domain joined host, the data will be similar except 4624 logon will be a domain user over NTLM. Join LogonID from 4624 with LogonID on 5145
		* [CVE-2021-43893](https://bugs.chromium.org/p/project-zero/issues/detail?id=2228)
			* Network
			  * Inbound network connection over port 445
			  * Connection over pipe `efsrpc`
			  * Methods
				* `EfsRpcOpenFileRaw`
				* `EfsRpcEncryptFileSrv`
				* `EfsRpcCloseRaw `
				* `EfsRpcReadFileRaw`
				* `EfsRpcEncryptFileSrv`
			* Host
				* (Server Side)
					* Event ID 5145 on Target
						* Account Name: domain user
						* Object Type: `File`
						* Share Name: `\\*\IPC$`
						* Relative Target Name: `efsrpc`
						* Access Mask:  `0x12019F`
						* Accesses
							* `READ_CONTROL`
							* `SYNCHRONIZE`
							* `ReadData (or ListDirectory)`
							* `WriteData (or AddFile)`
							* `AppendData (or AddSubdirectory or CreatePipeInstance)`
							* `ReadEA`
							* `WriteEA`
							* `ReadAttributes`
							* `WriteAttributes`
					* Event ID 4624 on Target
						* Logon Type: `3`
						* Account Name: domain user
						* Process ID: `0x0`
						* Elevated Token: `Yes`
					* Sysmon EID 11 on Target
						* FileName: Name of newly created file
			* Join on LogonID for queries.
			* Wouldn't be uncommon to see multiple events if the attacker was creating a directory and uploading a file.
	* <details><summary>Prevention (Click to expand)</summary><p>
		* Apply MSFT Patch (Read: https://tiraniddo.dev/2021/08/how-to-secure-windows-rpc-server-and.html by @tiraniddo to understand better)
		* Turn off EFS Service
		* Set EFS Service Startup Type to Disabled
		* Apply RPC Filter
		* Certificate Mitigation: https://blog.malwarebytes.com/exploits-and-vulnerabilities/2021/07/microsoft-provides-more-mitigation-instructions-for-the-petitpotam-attack/
		* Disable NTLM Authentication
		* Enable SMB signing
		* MSFT Suggestions: https://support.microsoft.com/en-gb/topic/kb5005413-mitigating-ntlm-relay-attacks-on-active-directory-certificate-services-ad-cs-3612b773-4043-4aa9-b23d-b87910cd3429
		* RPC Filter Example

				rpc
				filter
				add rule layer=um actiontype=permit
				add condition field=if_uuid matchtype=equal data=c681d488-d850-11d0-8c52-00c04fd90f7e
				add condition field=auth_type matchtype=equal data=16
				add condition field=auth_level matchtype=equal data=6
				add filter
				add rule layer=um actiontype=block
				add condition field=if_uuid matchtype=equal data=c681d488-d850-11d0-8c52-00c04fd90f7e
				add filter
				add rule layer=um actiontype=permit
				add condition field=if_uuid matchtype=equal data=df1941c5-fe89-4e79-bf10-463657acf44d
				add condition field=auth_type matchtype=equal data=16
				add condition field=auth_level matchtype=equal data=6
				add filter
				add rule layer=um actiontype=block
				add condition field=if_uuid matchtype=equal data=df1941c5-fe89-4e79-bf10-463657acf44d
				add filter
				quit
			* This filter will only allow connections through `681d488-d850-11d0-8c52-00c04fd90f7e` & `df1941c5-fe89-4e79-bf10-463657acf44d` if the authentication type is `Kerberos (16)` and the authentication type is `RPC_C_AUTHN_LEVEL_PKT_PRIVACY (6)`. This is going to prevent NTLM from being used and inturn relay from being performed.
			* Due to `RPC_C_AUTHN_LEVEL_PKT_PRIVACY (6)` being set, this will also block [CVE-2021-43893](https://bugs.chromium.org/p/project-zero/issues/detail?id=2228) as well.
			* Another option is a filter James Forshaw created: https://gist.github.com/tyranid/5527f5559041023714d67414271ca742
* <details><summary>MS-NRPC: Netlogon Remote Protocol ([`Exploitation of Remote Services` TTP](TTP/T1210_Exploitation_of_Remote_Services/T1210.md)) (Click to expand)</summary><p>
	* <details><summary>References (Click to expand)</summary><p>
		* https://github.com/jsecurity101/MSRPC-to-ATTACK/blob/main/documents/MS-NRPC.md
		* [https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/19896c1c-7e64-419b-a759-a9dc5662a780](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/19896c1c-7e64-419b-a759-a9dc5662a780)
		* https://www.secura.com/uploads/whitepapers/Zerologon.pdf
		* https://dirkjanm.io/a-different-way-of-abusing-zerologon/
		* https://www.kroll.com/en/insights/publications/cyber/cve-2020-1472-zerologon-exploit-detection-cheat-sheet
	* <details><summary>Overview (Click to expand)</summary><p>
		* Known Threats
			* Zerologon
			  * Netlogon calls are not encrypted
				* Caused by an attacker forcing SMB fallback right after the machine performed authentication handshake, in turn disabling force encryption.
				* Done by injecting TCP RST packets when the client attempts to connect to port 135 or the dynamic Netlogon port,
				* Attacker could replace a logon failed with a logon success message, giving access to DC.
	* Protocol
		* [Netlogon Remote Protocol - (NRPC)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/ff8f970f-3e37-40f7-bd4b-af7336e4792f)
	* Interface UUID
		* 12345678-1234-ABCD-EF00-01234567CFFB
	* Server Binary
		* netlogon.dll (loads into) lsass.exe
	* Endpoint
		* ncacn_ip_tcp
		* ncacn_np: `\PIPE\lsass` alias `\pipe\netlogon`
	* ATT&CK Relation
		* Netlogon Elevation of Privilege Vulnerability (Zerologon)
		* [T1210 - Exploitation of Remote Services](https://attack.mitre.org/techniques/T1210/)
	* <details><summary>Indicator of Activity (IOA) (Click to expand)</summary><p>
		* Network
		  * Method (either over TCP or named pipe - `lsass`/`netlogon`)
			* NetrServerAuthenticate2/3 (high volume)
			* NetrServerPasswordSet2
			* NetrServerReqChallenge (high volume)
			* NetrLogonSamLogonWithFlags
			* DRS Methods (DrsGetNCChanges) (Zerologon attack specific)
		* Host
		  * Window Security Event - 4624
			* Anonymous Logon or DC Computer Account
			* Logon Type 3
			* Auth Package: NTLM
			* Logon Process: NtLmSsp
			* Source Network Address & Workstation Name will show source
			* Logon ID tie to other events (4742)
		  * Window Security Event - 4742
			* Look for password last set on DCs
			* Account Name is DC Machine Account
			* Security ID - same as 4624
		  * Tie Logon ID to 4624
	* <details><summary>Prevention (Click to expand)</summary><p>
		* Microsoft Patch: https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-1472
		* RPC Filter

				rpc
				filter
				add rule layer=um actiontype=permit
				add condition field=if_uuid matchtype=equal data=12345678-1234-abcd-ef00-01234567cffb
				add condition field=remote_user_token matchtype=equal data=D:(A;;CC;;;DC)
				add condition field=remote_user_token matchtype=equal data=D:(A;;CC;;;AU)
				add filter
				add rule layer=um actiontype=block
				add condition field=if_uuid matchtype=equal data=12345678-1234-abcd-ef00-01234567cffb
				add filter
				quit
			* Still need to apply patch from Microsoft, but this filter will remove the ability for non-domain joined computers & unauthenticated users from using this interface.
			* Being that Netlogon is a service, unsure of the impacts if the filter were changed to only allow domain computers and domain admins.
		* If NTLM isn't allowed in organization, this filter might be a better alternative

				rpc
				filter
				add rule layer=um actiontype=permit
				add condition field=if_uuid matchtype=equal data=12345678-1234-abcd-ef00-01234567cffb
				add condition field=auth_type matchtype=equal data=16
				add condition field=auth_level matchtype=equal data=6
				add condition field=remote_user_token matchtype=equal data=D:(A;;CC;;;DC)
				add condition field=remote_user_token matchtype=equal data=D:(A;;CC;;;AU)
				add filter
				add rule layer=um actiontype=block
				add condition field=if_uuid matchtype=equal data=12345678-1234-abcd-ef00-01234567cffb
				add filter
				quit
* <details><summary>MS-FSRVP: File Server Remote VSS Protocol ([`Forced Authentication - MS-FSRVP` TTP](TTP/T1187_Forced_Authentication/T1187.md), [` Adversary-in-the-Middle: LLMNR/NBT-NS Poisoning and SMB Relay ` TTP](TTP/T1557_Adversary-in-the-Middle/001_LLMNR-NBT-NS_Poisoning_and_SMB_Relay_By_responding_to_LLMNR-NBT-NS_network_traffic/T1557.001.md)) (Click to expand)</summary><p>
	* <details><summary>References (Click to expand)</summary><p>
		* https://github.com/jsecurity101/MSRPC-to-ATTACK/blob/main/documents/MS-FSRVP.md
		* [https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-fsrvp/67f0fdd9-d8bc-445d-95de-2cb6d5c4d149](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-fsrvp/67f0fdd9-d8bc-445d-95de-2cb6d5c4d149)
		* Credit to [Lionel Gilles](https://twitter.com/topotam77) for introducing this attack and [Charlie Bromberg](https://twitter.com/_nwodtuhs) for POC.
		* https://pentestlaboratories.com/2022/01/11/shadowcoerce/
	* Protocol
		* [File Server Remote VSS Protocol - MS-FSRVP](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-fsrvp/67f0fdd9-d8bc-445d-95de-2cb6d5c4d149)
	* Interface UUID
		* `a8e0653c-2744-4389-a61d-7373df8b2292`
	* Server Binary
		* `fssagent.dll` loads into `svchost.exe`
	* Endpoint
		* ncacn_np: `\\pipe\FssagentRpc`
	* ATT&CK Relation
		* [T1187 - Forced Authentication](https://attack.mitre.org/techniques/T1187/)
		* [T1557 - LLMNR/NBT-NS Poisoning and SMB Relay](https://attack.mitre.org/techniques/T1557/001/)
		* [ShadowCoerce](https://github.com/ShutdownRepo/ShadowCoerce)
	* <details><summary>Indicator of Activity (IOA) (Click to expand)</summary><p>
		* Network
		  - NTLM Authentication requests (zeek - ntlm.log)
		* RPC Methods
		  * IsPathSupported
		  * IsPathShadowCopied
		* Host
		  - Inbound connection over port 445 to `System` process (WSE - 5156 + Sysmon - 3)
		  - Pipe connection `\FssagentRpc` from `System` process  (Sysmon - 18)
		  - fssagent.dll loaded into svchost.exe (Sysmon -7)
		  - LogonEvent
			  - LogonType: `3`
			  - Elevated Token: `Yes`
			  - Account Name: <Domain User>
			  - LogonProcess: `NtlmSsp`
			  - Auth Package: `NTLM`
		  - Network Share Event
			  - Account Name: <Domain User> (same logon id as logon event)
			  - Object Type: File
			  - Share Name `\\*\IPC$`
			  - Relative Target Name: `FssagentRpc`
			  - AccessMask: `0x3`
			  - Accesses
				  - `ReadData (or ListDirectory)`
				  - `WriteData (or AddFile)`
	* <details><summary>Prevention (Click to expand)</summary><p>
		* Turn off fssagent Service
		* Set fssagent Service Startup Type to Disabled
		* Certificate Mitigation: https://blog.malwarebytes.com/exploits-and-vulnerabilities/2021/07/microsoft-provides-more-mitigation-instructions-for-the-petitpotam-attack/
		* Disable NTLM Authentication
		* RPC Filters

					rpc
					filter
					add rule layer=um actiontype=permit
					add condition field=if_uuid matchtype=equal data=a8e0653c-2744-4389-a61d-7373df8b2292
					add condition field=auth_type matchtype=equal data=16
					add condition field=auth_level matchtype=equal data=6
					add filter
					add rule layer=um actiontype=block
					add condition field=if_uuid matchtype=equal data=a8e0653c-2744-4389-a61d-7373df8b2292
					add filter
					quit
			* When set this will not relay NTLM auth.
		* Another option is to block the interface altogether or specify the domain group allowed to request this information

					rpc
					filter
					add rule layer=um actiontype=permit
					add condition field=if_uuid matchtype=equal data=a8e0653c-2744-4389-a61d-7373df8b2292
					add condition field=remote_user_token matchtype=equal data=D:(A;;CC;;;DA)
					add filter
					add rule layer=um actiontype=block
					add condition field=if_uuid matchtype=equal data=a8e0653c-2744-4389-a61d-7373df8b2292
					add filter
					quit
* <details><summary>MS-DSSP: Directory Services Setup Remote Protocol (Click to expand)</summary><p>
	* <details><summary>References (Click to expand)</summary><p>
		* [https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dssp/d9125d4c-eca6-48dd-9d84-be6370033866](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dssp/d9125d4c-eca6-48dd-9d84-be6370033866)
	* Attacker Usage
		* LSA Directory Services (DS) interface, used to enumerate domains and trust relationships
	* Interface UUID
		* `3919286a-b10c-11d0-9ba8-00c04fd92ef5`
	* Server Binary
		* `fssagent.dll` loads into `svchost.exe`
	* Endpoint
		* ncacn_np: `\\pipe\lsarpc`
* <details><summary>MS-DCOM: Distributed Component Object Model (DCOM) Remote Protocol (Click to expand)</summary><p>
	* <details><summary>References (Click to expand)</summary><p>
		* [https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/4a893f3d-bd29-48cd-9f43-d9777a4415b0](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/4a893f3d-bd29-48cd-9f43-d9777a4415b0)
	* Attacker Usage
		* DCOM interface, supporting WMI
	* Interface UUID
		* `?`
	* Server Binary
		* `?`
	* Endpoint
		* `?`
