<!---------------------------------------------------------------------------------
Copyright: (c) BLS OPS LLC.
This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, version 3.
This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.
You should have received a copy of the GNU General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.
--------------------------------------------------------------------------------->
# Malware Coding
## References

* <details><summary>References (Click to expand)</summary><p>
	* <details><summary>Education (Click to expand)</summary><p>
		* 0xPat blog: Malware Development Series (Part 1) -<br />[https://0xpat.github.io/Malware_development_part_1/](https://0xpat.github.io/Malware_development_part_1/)
		* roberreigada blog: Playing with an EDR: Cylance-<br />[https://roberreigada.github.io/posts/playing_with_an_edr/](https://roberreigada.github.io/posts/playing_with_an_edr/)
	* [https://twitter.com/BillDemirkapi](https://twitter.com/BillDemirkapi)
	* Bill Demirkapi's Blog: "Abusing Windows’ Implementation of Fork() for Stealthy Memory Operations" -<br />[https://billdemirkapi.me/abusing-windows-implementation-of-fork-for-stealthy-memory-operations/](https://billdemirkapi.me/abusing-windows-implementation-of-fork-for-stealthy-memory-operations/)
	* matteomalvica blog: "Evading WinDefender ATP credential-theft: a hit after a hit-and-miss start" -<br />[https://www.matteomalvica.com/blog/2019/12/02/win-defender-atp-cred-bypass/](https://www.matteomalvica.com/blog/2019/12/02/win-defender-atp-cred-bypass/)

## Overview

Several TTPs are consistently present through each of the steps

* User Execution - Malicious File ([`User Execution - Malicious File` TTP](TTP/T1204_User_Execution/002_Malicious_File/T1204.002.md))
* Develop Capabilities - Malware ([`Develop Capabilities - Malware` TTP](TTP/T1587_Develop_Capabilities/001_Malware/T1587.001.md))
* [`Exploitation for Defense Evasion` TTP](TTP/T1211_Exploitation_for_Defense_Evasion/T1211.md)

## Example Attacks: Match enum. to reqs

* <details><summary>Reverse Shells ([Windows Reverse Shells Guide](Testaments_and_Books/Redvelations/Windows/004-1_Windows_Reverse_Shells.md))</summary><p>
	* Technique
		1. Side load into a legitimate Windows process (bypassing Application Whitelisting controls).
		1. Once the DLL loader is loaded into memory, it utilizes a technique to flush an EDR’s hook out of the system DLLs running in the process's memory.
* Other Exploitation
	* Broad Exploit Suites ([Windows CVE Exploitation Guide](Testaments_and_Books/Redvelations/Windows/006-2_Windows_CVE_Exploitation.md))
	* Broad Windows Malware Suites
		* <details><summary>TikiTorch (rasta-mouse) (Click to expand)</summary><p>
			* [https://github.com/rasta-mouse/TikiTorch](https://github.com/rasta-mouse/TikiTorch)
			* TikiLoader - Core DLL that handles all of the actual spawning and injection logic.
			* TikiSpawn - Demo console app showing how to consume the TikiLoader.
			* Based on (unmaintained) CACTUSTORCH -<br />[https://github.com/vysecurity/CACTUSTORCH](https://github.com/vysecurity/CACTUSTORCH)
			* Basics
				1. Spawns a new process
				1. Allocates a region of memory
				1. Writes shellcode into that region
				1. Uses CreateRemoteThread to execute said shellcode.
					* Both the process and shellcode are specified by the user.
					* The primary use case is as a JavaScript/VBScript loader via DotNetToJScript, which can be utilised in a variety of payload types such as HTA and VBA.
			* Advanced processs spawning and injection
				* Spawn x86 and x64 processes
				* PPID Spoofing and BlockDLLs
				* Supports Module Stomping and Process Hollowing for injection
				* Utilises DInvoke to call Nt* APIs, or optionally use Syscalls
			* Basic Usage

					using System.Diagnostics;
					using TikiLoader;

					var hollower = new Hollower
					{
					    BinaryPath = @"C:\Windows\System32\notepad.exe",
					    WorkingDirectory = @"C:\Windows\System32",
					    ParentId = Process.GetProcessesByName("explorer")[0].Id,
					    BlockDlls = true
					};
					            
					hollower.Hollow(Shellcode, true);
				
## Attack Guide. Build your own attack.

1. Generate, Write, or Retrieve Code/Binary/Scripts
	* <details><summary>Code (Click to expand)</summary><p>
		* Malicious LoadLibraries
			* DarkLoadLibrary -<br />[https://github.com/bats3c/DarkLoadLibrary](https://github.com/bats3c/DarkLoadLibrary)
		* Unhooking ([Unhooking Guide](Testaments_and_Books/Redvelations/Windows/005-2_Unhooking.md))
		* <details><summary>Shellcode (Click to expand)</summary><p>
			* Generators
				* D/Invoke
					* DInjector
						* [https://github.com/snovvcrash/DInjector](https://github.com/snovvcrash/DInjector)
						* accumulation of my code snippets for various shellcode injection techniques using fantastic D/Invoke API by @TheWover and @FuzzySecurity.
						* Features
							* Fully ported to D/Invoke API.
							Encrypted payloads which can be invoked from a URL or passed in base64 as an argument.
							Built-in AMSI bypass based on @rasta-mouse method.
							Sandbox detection & evasion
		* <details><summary>Exploit (Click to expand)</summary><p>
			*  Thread Call Stack Evasion
	* <details><summary>"Pre-Created" Malicious Exploit Files(Click to expand)</summary><p>
		* <details><summary>Enumeration Files(Click to expand)</summary><p>
			* Certify.exe
				* ADCS Enumeration
			* Seatbelt.exe
				* AD/Windows Misconfiguration Checks
		* <details><summary>Exploitation Files(Click to expand)</summary><p>
			* Suites
				* WinPwn -<br />[https://github.com/S3cur3Th1sSh1t/WinPwn/](https://github.com/S3cur3Th1sSh1t/WinPwn/)
					* Capabilities
						* @ly4k_'s CallbackHell exploit
1. Obfuscate
	* Code
		* <details><summary>VBA (Click to expand)</summary><p>
			* <details><summary>Repositiories/Guides (Click to expand)</summary><p>
				* S3cur3Th1sSh1t - OffensiveVBA -<br />[https://github.com/S3cur3Th1sSh1t/OffensiveVBA](https://github.com/S3cur3Th1sSh1t/OffensiveVBA)
				* RastaMouse AMSI Memory Bypass -<br />[https://rastamouse.me/memory-patching-amsi-bypass/](https://rastamouse.me/memory-patching-amsi-bypass/)
		* <details><summary>Windows Binaries (Click to expand)</summary><p>
			* PEzor
			* Confuzer
		* <details><summary>Shellcode (Click to expand)</summary><p>
	* Package
		* <details><summary>Zip (Click to expand)</summary><p>
			* ZipExec -<br />[https://github.com/Tylous/ZipExec](https://github.com/Tylous/ZipExec)
		* <details><summary>DRM Protection (Click to expand)</summary><p>
			* Skrull -<br />[https://github.com/aaaddress1/Skrull](https://github.com/aaaddress1/Skrull)
				* Skrull is a malware DRM, that prevents Automatic Sample Submission by AV/EDR and Signature Scanning from Kernel. It generates launchers that can run malware on the victim using the Process Ghosting technique. Also, launchers are totally anti-copy and naturally broken when got submitted.
1. Check Execution against AV and EDR
1. Deliver
	* Phishing ([Guide](Testaments_and_Books/Redvelations/Phishing/000_Phishing.md))
	* Windows Execution ([Guide](Testaments_and_Books/Redvelations/Windows/002-0_Windows_Execution.md))
1. Execute
	* LOLBAs ([Guide](Testaments_and_Books/Redvelations/Windows/002-4_LOLBAS.md))
	* Windows Execution ([Guide](Testaments_and_Books/Redvelations/Windows/002-0_Windows_Execution.md))
1. Additional
	* <details><summary>Lsass NTLM Authentication Backdoor (Click to expand)</summary><p>
		* Nosferatu -<br />[https://github.com/kindtime/nosferatu](https://github.com/kindtime/nosferatu)
			* Must be compiled as a 64 bit DLL. It must be injected using the a DLL Injector with SeDebugPrivilege.
				1. The DLL is injected into the `lsass.exe` process
				1. DLL begins hooking authentication WinAPI calls.
				1. The targeted function is `MsvpPasswordValidate()`, located in `NtlmShared.dll`. In the pursuit of not being detected, the hooked function will call the original function and allow for the normal flow of authentication. Only after seeing that authentication has failed will the hook swap out the actual NTLM hash with the backdoor hash for comparison.
			* Usage (PowerShell)PowerShell 

					.\privileged-injector.exe C:\Users\Administrator\backdoortest\nosferatu.dll

### Needs Research

* C2
	* "inject-assembly - Execute .NET in an Existing Process" -<br />[https://github.com/kyleavery/inject-assembly](https://github.com/kyleavery/inject-assembly)
* splinter_Code blog: "The hidden side of Seclogon part 2: Abusing leaked handles to dump LSASS memory" -<br />[https://splintercod3.blogspot.com/p/the-hidden-side-of-seclogon-part-2.html](https://splintercod3.blogspot.com/p/the-hidden-side-of-seclogon-part-2.html)


