<!---------------------------------------------------------------------------------
Copyright: (c) BLS OPS LLC.
This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, version 3.
This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.
You should have received a copy of the GNU General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.
--------------------------------------------------------------------------------->
# Oracle Cloud Infrastructure Pentesting

## References

* Oracle Cloud Infrastructure Security Guide -<br />[https://docs.oracle.com/en-us/iaas/Content/Security/Concepts/security_guide.htm](https://docs.oracle.com/en-us/iaas/Content/Security/Concepts/security_guide.htm)
* Oracle Cloud Infrastructure Documentation: Security Best Practices -<br />[https://docs.oracle.com/en-us/iaas/Content/Security/Reference/configuration_security.htm](https://docs.oracle.com/en-us/iaas/Content/Security/Reference/configuration_security.htm)
* OCI Documentation: Description of policies, including verbs<br />[https://docs.oracle.com/en-us/iaas/Content/Identity/Concepts/policies.htm](https://docs.oracle.com/en-us/iaas/Content/Identity/Concepts/policies.htm)


## Overview


Check for the below occurences:
* Publicly exposed resources
* Security lists that allow users to either **manage** or **use** sensitive resources
* #@TODO - Need to make this list more comprehensive
* Review the OCI Auditing guide for more ideas.


## Noteworthy Security List Information

Security Lists are policies that define permissions using specific **verbs**. Understand the below to know how much permission you may have.

**Description of Security List Verbs**

**Verbs**
* **inspect**
    * Ability to list resources, without access to any confidential information or user-specified metadata that may be part of that resource. Important: The operation to list policies includes the contents of the policies themselves, and the list operations for the Networking resource-types return all the information (e.g., the contents of security lists and route tables).
    * Third-party auditors
* **read**
    * Includes inspect plus the ability to get user-specified metadata and the actual resource itself.
    * Internal auditors
* **use**
    * Includes read plus the ability to work with existing resources (the actions vary by resource type). Includes the ability to update the resource, except for resource-types where the "update" operation has the same effective impact as the "create" operation (e.g., UpdatePolicy, UpdateSecurityList, etc.), in which case the "update" ability is available only with the manage verb. In general, this verb does not include the ability to create or delete that type of resource.
    * Day-to-day end users of resources
* **manage**
    * Includes all permissions for the resource.
    * Administrators

**Special exceptions to Security Lists**

* Users
    * Access to both manage users and manage groups lets you do anything with users and groups, including creating and deleting users and groups, and adding/removing users from groups. To add/remove users from groups without access to creating and deleting users and groups, only both use users and use groups are required. See Common Policies.
* Policies
    * The ability to update a policy is available only with manage policies, not use policies, because updating a policy is similar in effect to creating a new policy (you can overwrite the existing policy statements). In addition, inspect policies lets you get the full contents of the policies.
* Object Storage objects
    * **inspect objects** lets you list all the objects in a bucket and do a HEAD operation for a particular object. In comparison, **read objects** lets you download the object itself.
* Load Balancing resources
    * Be aware that inspect load-balancers lets you get all information about your load balancers and related components (backend sets, etc.).
* Networking resources:
    * Be aware that the inspect verb not only returns general information about the cloud network's components (for example, the name and OCID of a security list, or of a route table). It also includes the contents of the component (for example, the actual rules in the security list, the routes in the route table, and so on).
    * Also, the following types of abilities are available only with the manage verb, not the use verb:
        * Update (enable/disable) internet-gateways
        * Update security-lists
        * Update route-tables
        * Update dhcp-options
        * Attach a dynamic routing gateway (DRG) to a virtual cloud network (VCN)
        * Create an IPSec connection between a DRG and customer-premises equipment (CPE)
        * Peer VCNs

## Pentesting

### Security Lists

Security lists are easy to misconfigure and give too much permission to a group.

An example security list permissions is written as:
```
Allow group NewtworkAdmins to manage virtual-network-family in compartment CompartmentA
```

To restrict the "delete" and "update" functions for something such as a security list, the below policy could be used:
```
Allow group PolicyAdmins to use policies in tenancy
Allow group PolicyAdmins to manage policies in tenancy
 where request.permission='POLICY_CREATE'
```
This security policy statement explicitly only allows POLICY_CREATE permission, and not to POLICY_DELETE and POLICY_UPDATE.

Security lists follow this format typically and come with a very user-friendly option for creation.

A misconfigured security list would allow the affected 

## Dynamic Groups and Instances

### References

* Installation of OCI CLI on instaces -<br />[https://docs.oracle.com/en-us/iaas/Content/API/SDKDocs/cliinstall.htm](https://docs.oracle.com/en-us/iaas/Content/API/SDKDocs/cliinstall.htm)

### Detail

Tenants can setup instances to automatically perform routine actions in the tenancy. This relies on a few components:
* Instances have immutable permissions upon creation (Default)
* Any user in the instance has these default, immutable permissions
    * Any user that establishes an SSH connection to the instance, therefore, has the OCI permissions of the instance
    * The default user is a known user. This user may also sudo to root without a password. This only matters if there are host-based controls that restrict usage of the OCI CLI to the root user.
    * Access to instances is restricted by a generated SSH public/private key pair available only at the initial instance generation
* Security Lists can define permission sets for users or groups
* Dynamic groups (a type of group) can be defined to include specific instances
* The OCI CLI must be installed for users of the instance to perform actions in the OCI environment
    * An attacker on the instance with appropriate permissions and network access could install the OCI following these steps:
        * Linux and Unix
            * ```
                bash -c "$(curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh)"
                ```
        * Oracle Linux 8
            * ```
                sudo dnf -y install oraclelinux-developer-release-el8
                sudo dnf install python36-oci-cli
                ```
        * Oracle Linux 7
            * ```
                sudo yum install python36-oci-cli
                ```
        * Windows
            * ```PowerShell
                Set-ExecutionPolicy RemoteSigned
                Invoke-WebRequest https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.ps1 -OutFile install.ps1
                iex ((New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.ps1'))
                ```
            * The final command may be replaced with this command to accept all prompts:
                ```PowerShell
                install.ps1 -AcceptAllDefaults
                ```
        * MacOS
            * ```
                brew update && brew install oci-cli
                ```
* OCI CLI parameters require the knowledge of large, unpredictable strings that identify specific details such as the namespace and the compartment ID. 
* By default, instances have both the legacy (v1) and current (v2) versions of metadata exposed. Metadata is a common concept in cloud instances across brands. For Oracle instances, this information provides the unique identification information useful for the OCI CLI parameters. The legacy version does not require authentication in heads, and can be accessed by using CURL to access specific, known endpoints.

The intended design is to have a "service principal" established in the instance the automatically performs actions in the environment. The owner of the instance can either set this up to automatically affect the environment, or to be managed by an authenticated user. If the SSH key is compromised, and the attacker is in a network that can access the instance, the attacker has the same permission set granted to the instance.

### Attack Scenario Example - Publicly Exposed Instance

An example attack scenario involving this chain looks like this:
1. The attacker identifies a publicly available instance exposed
1. The attack compromises the SSH key to the instance
    * Either the key or a valid workstation could be compromised
1. The attacker authenticates to the instance
1. The attacker gathers situational awareness (SA) of the environment through OCI CLI
    * The attacker checks environment variables
    * The attacker checks known endpoints for metadata information
1. The attacker attempts to perform actions with acceptable identifiers in the OCI CLI
1. The security list is over-permissive and allows the attacker to control the environment
    * The instance may have permissions to **manage** resources within the **tenancy** or a known compartment.